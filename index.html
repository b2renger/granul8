<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Granular Sampler</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="audio-unlock-overlay">
        <div class="unlock-content">
            <h1 class="unlock-title">Granul8</h1>
            <p class="unlock-description">A granular sampler and loopstation<br>for the web and multitouch devices</p>
            <div class="unlock-icon"></div>
            <div class="unlock-text">Tap to start</div>
            <div class="unlock-credits">All sounds from <a href="https://freemusicarchive.org/home" target="_blank" rel="noopener">Free Music Archive</a></div>
        </div>
    </div>

    <div id="app">
        <header id="top-bar">
            <h1>Granul8</h1>
            <div id="file-controls">
                <select id="sample-select">
                    <option value="">— Select a sample —</option>
                    <option value="samples/Soni_Ventorum_Wind_Quintet_-_08_-_Danzi_Wind_Quintet_Op_67_No_3_In_E-Flat_Major_4_Allegretto.mp3" selected>Danzi Wind Quintet — Allegretto</option>
                    <option value="samples/Real Vocal String Quartet - Chorale.mp3">Real Vocal String Quartet — Chorale</option>
                    <option value="samples/Slaveya Women's Vocal Ensemble - Hey Petrunka.mp3">Slaveya Women's Vocal — Hey Petrunka</option>
                    <option value="samples/PulseBox - Smooth Jazz.mp3">PulseBox — Smooth Jazz</option>
                    <option value="samples/Jangwa - chiara's birthday.mp3">Jangwa — Chiara's Birthday</option>
                    <option value="samples/The Derek Piotr Fieldwork Archive - Till the Clouds Rolled By.mp3">Derek Piotr Fieldwork — Till the Clouds Rolled By</option>
                    <option value="samples/Ketsa - You da Bossa.mp3">Ketsa — You da Bossa</option>
                    <option value="samples/Samuel Corwin - Tibetan Monks Chanting at Gyuto Branch Monastery House No. 422, McLeod Ganj.mp3">Samuel Corwin — Tibetan Monks Chanting</option>
                    <option value="samples/Veena Kinhal - Haratanaya Sree.mp3">Veena Kinhal — Haratanaya Sree</option>
                </select>
                <button id="load-sample-btn" type="button">Load File</button>
                <input type="file" id="file-input" accept="audio/*" hidden>
                <span id="sample-name">No sample loaded</span>
                <span class="file-controls-sep"></span>
                <button id="session-export-btn" type="button" title="Export session as JSON">Export</button>
                <button id="session-import-btn" type="button" title="Import session from JSON">Import</button>
                <input type="file" id="session-import-input" accept=".json,application/json" hidden>
            </div>
            <div id="master-volume-control">
                <label for="master-volume" title="Main Volume">Main Volume</label>
                <input type="range" id="master-volume" min="0" max="1" value="0.7" step="0.01">
                <span class="param-value" id="val-master-volume">0.70</span>
            </div>
            <div id="tempo-control">
                <div class="tempo-bpm">
                    <label for="param-bpm">BPM</label>
                    <input type="range" id="param-bpm" min="40" max="300" value="120" step="1">
                    <span class="param-value" id="val-bpm">120</span>
                    <button id="tap-tempo" type="button" title="Tap tempo">TAP</button>
                </div>
                <div id="time-sig-control" class="time-sig-control">
                    <select id="time-sig-num" title="Beats per bar">
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4" selected>4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                        <option value="11">11</option>
                        <option value="12">12</option>
                    </select>
                    <span class="time-sig-slash">/</span>
                    <select id="time-sig-den" title="Beat unit">
                        <option value="4" selected>4</option>
                        <option value="8">8</option>
                        <option value="16">16</option>
                    </select>
                </div>
                <div id="metronome-control" class="metronome-control">
                    <button id="btn-metronome" type="button" title="Toggle metronome click" class="metronome-btn">♩</button>
                    <input type="range" id="metronome-volume" min="0" max="1" value="0.5" step="0.01" title="Metronome volume">
                </div>
                <div id="beat-indicator" class="beat-indicator"></div>
            </div>
            <button id="theme-toggle" type="button" title="Toggle theme">
                <span class="theme-icon">
                    <span class="theme-icon-sun"></span>
                    <span class="theme-icon-moon"></span>
                </span>
            </button>
        </header>

        <div id="tab-bar">
            <div id="tab-list"></div>
            <button id="tab-add" type="button" title="Add instance">+</button>
        </div>

        <main id="main-area">
            <div id="waveform-container">
                <canvas id="waveform-canvas"></canvas>
                <div id="drop-overlay" hidden>Drop audio file here</div>
            </div>

            <div id="transport-bar">
                <div id="bar-count-selector" class="bar-count-selector">
                    <button class="bar-count-btn" data-bars="1">1</button>
                    <button class="bar-count-btn" data-bars="2">2</button>
                    <button class="bar-count-btn" data-bars="3">3</button>
                    <button class="bar-count-btn active" data-bars="4">4</button>
                </div>
                <button id="btn-record" type="button" title="Record">
                    <span class="icon record-icon"></span>
                </button>
                <button id="btn-overdub" type="button" title="Overdub — layer new gestures on existing recording" disabled>
                    <span class="icon overdub-icon"></span>
                </button>
                <button id="btn-play" type="button" title="Play" disabled>
                    <span class="icon play-icon"></span>
                </button>
                <button id="btn-stop" type="button" title="Stop" disabled>
                    <span class="icon stop-icon"></span>
                </button>
                <button id="btn-loop" type="button" title="Loop" disabled>
                    <span class="icon loop-icon"></span>
                </button>
                <button id="btn-snap-grid" type="button" title="Snap loop to BPM grid" class="snap-btn">
                    <span class="snap-icon">⊞</span>
                </button>
                <button id="btn-loop-station" type="button" title="Loop station mode (bar-aligned sync)" class="loop-station-btn">LS</button>
                <div id="level-meter" title="Output Level">
                    <div class="level-meter-fill"></div>
                </div>
                <span id="time-display">00:00.000</span>
                <div id="transport-progress">
                    <div id="transport-progress-fill"></div>
                    <div id="loop-region"></div>
                    <div id="loop-start-handle" class="loop-handle" title="Loop start"></div>
                    <div id="loop-end-handle" class="loop-handle" title="Loop end"></div>
                </div>
            </div>

            <div id="parameter-panel">
                <details class="panel-section" open>
                    <summary>Rhythm and Harmony</summary>
                    <div class="section-content musical-content">
                        <div class="param-group">
                            <label for="param-root-note">Root Note</label>
                            <select id="param-root-note">
                                <option value="0" selected>C</option>
                                <option value="1">C#</option>
                                <option value="2">D</option>
                                <option value="3">D#</option>
                                <option value="4">E</option>
                                <option value="5">F</option>
                                <option value="6">F#</option>
                                <option value="7">G</option>
                                <option value="8">G#</option>
                                <option value="9">A</option>
                                <option value="10">A#</option>
                                <option value="11">B</option>
                            </select>
                        </div>
                        <div class="param-group">
                            <label for="param-scale">Scale</label>
                            <select id="param-scale">
                                <option value="chromatic" selected>Chromatic</option>
                                <option value="major">Major (Ionian)</option>
                                <option value="minor">Minor (Aeolian)</option>
                                <option value="dorian">Dorian</option>
                                <option value="phrygian">Phrygian</option>
                                <option value="lydian">Lydian</option>
                                <option value="mixolydian">Mixolydian</option>
                                <option value="locrian">Locrian</option>
                                <option value="harmonicMinor">Harmonic Minor</option>
                                <option value="melodicMinor">Melodic Minor</option>
                                <option value="pentatonic">Pentatonic</option>
                                <option value="minorPentatonic">Minor Pentatonic</option>
                                <option value="blues">Blues</option>
                                <option value="wholeTone">Whole Tone</option>
                            </select>
                        </div>
                        <div class="param-group quantize-toggles">
                            <label>Quantize</label>
                            <div class="toggle-row">
                                <label class="toggle-label">
                                    <input type="checkbox" id="quantize-grain-size">
                                    <span class="toggle-switch"></span>
                                    Grain Size
                                </label>
                                <select id="subdiv-grain-size" class="subdiv-select" disabled>
                                    <optgroup label="Binary">
                                        <option value="1">1/1</option>
                                        <option value="2">1/2</option>
                                        <option value="4" selected>1/4</option>
                                        <option value="8">1/8</option>
                                        <option value="16">1/16</option>
                                        <option value="32">1/32</option>
                                    </optgroup>
                                    <optgroup label="Ternary">
                                        <option value="3">1/2T</option>
                                        <option value="6">1/4T</option>
                                        <option value="12">1/8T</option>
                                        <option value="24">1/16T</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="toggle-row">
                                <label class="toggle-label">
                                    <input type="checkbox" id="quantize-density">
                                    <span class="toggle-switch"></span>
                                    Density
                                </label>
                                <select id="subdiv-density" class="subdiv-select" disabled>
                                    <optgroup label="Binary">
                                        <option value="1">1/1</option>
                                        <option value="2">1/2</option>
                                        <option value="4" selected>1/4</option>
                                        <option value="8">1/8</option>
                                        <option value="16">1/16</option>
                                        <option value="32">1/32</option>
                                    </optgroup>
                                    <optgroup label="Ternary">
                                        <option value="3">1/2T</option>
                                        <option value="6">1/4T</option>
                                        <option value="12">1/8T</option>
                                        <option value="24">1/16T</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="toggle-row">
                                <label class="toggle-label">
                                    <input type="checkbox" id="quantize-pitch">
                                    <span class="toggle-switch"></span>
                                    Pitch
                                </label>
                            </div>
                        </div>
                        <div class="param-group quantize-toggles">
                            <label>Randomize</label>
                            <div class="toggle-row">
                                <label class="toggle-label">
                                    <input type="checkbox" id="random-grain-size">
                                    <span class="toggle-switch"></span>
                                    Grain Size
                                </label>
                                <label class="toggle-label">
                                    <input type="checkbox" id="random-density">
                                    <span class="toggle-switch"></span>
                                    Density
                                </label>
                                <label class="toggle-label">
                                    <input type="checkbox" id="random-pitch">
                                    <span class="toggle-switch"></span>
                                    Pitch
                                </label>
                                <label class="toggle-label">
                                    <input type="checkbox" id="random-pan">
                                    <span class="toggle-switch"></span>
                                    Pan
                                </label>
                            </div>
                        </div>
                        <div class="param-group" id="arp-mode-group" style="display: none;">
                            <label for="param-arp-pattern">Arp Mode</label>
                            <select id="param-arp-pattern">
                                <option value="random" selected>Random</option>
                                <option value="arpeggiator">Arpeggiator</option>
                            </select>
                        </div>
                        <div class="param-group" id="pitch-range-group" style="display: none;">
                            <label for="param-pitch-range">Pitch Range <span class="param-value" id="val-pitch-range">&plusmn;2 oct</span></label>
                            <input type="range" id="param-pitch-range" min="1" max="4" value="2" step="1">
                        </div>
                        <div class="param-group" id="arp-steps-group" style="display: none;">
                            <label for="param-arp-steps">Arp Steps <span class="param-value" id="val-arp-steps">4</span></label>
                            <input type="range" id="param-arp-steps" min="3" max="6" value="4" step="1">
                        </div>
                        <div class="param-group" id="arp-type-group" style="display: none;">
                            <label for="param-arp-type">Arp Type</label>
                            <select id="param-arp-type">
                                <option value="straight" selected>Straight</option>
                                <option value="looped">Looped</option>
                            </select>
                        </div>
                        <div class="param-group arp-style-group" id="arp-style-group" style="display: none;">
                            <label>Arp Shape <span class="param-value" id="val-arp-style">1/24</span></label>
                            <div class="arp-style-nav">
                                <button type="button" id="arp-style-prev" title="Previous pattern">&lsaquo;</button>
                                <svg id="arp-style-svg" class="arp-style-preview" viewBox="0 0 100 50"></svg>
                                <button type="button" id="arp-style-next" title="Next pattern">&rsaquo;</button>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="panel-section" open>
                    <summary>Sound Engine</summary>
                    <div class="section-content">
                        <div class="param-group range-group">
                            <label>Grain Size</label>
                            <div class="range-row">
                                <span class="range-label">Min</span>
                                <input type="range" id="param-grain-size-min" min="0" max="1" value="0.8674" step="0.001">
                                <span class="param-value" id="val-grain-size-min">400 ms</span>
                            </div>
                            <div class="range-row">
                                <span class="range-label">Max</span>
                                <input type="range" id="param-grain-size-max" min="0" max="1" value="0.8674" step="0.001">
                                <span class="param-value" id="val-grain-size-max">400 ms</span>
                            </div>
                            <div class="gesture-indicator" data-param="grainSize"></div>
                            <div class="random-range-bar" data-param="grainSize"></div>
                        </div>
                        <div class="param-group range-group">
                            <label>Density</label>
                            <div class="range-row">
                                <span class="range-label">Min</span>
                                <input type="range" id="param-density-min" min="0" max="1" value="0.651" step="0.001">
                                <span class="param-value" id="val-density-min">100 ms</span>
                            </div>
                            <div class="range-row">
                                <span class="range-label">Max</span>
                                <input type="range" id="param-density-max" min="0" max="1" value="0.651" step="0.001">
                                <span class="param-value" id="val-density-max">100 ms</span>
                            </div>
                            <div class="gesture-indicator" data-param="density"></div>
                            <div class="random-range-bar" data-param="density"></div>
                        </div>
                        <div class="param-group range-group">
                            <label>Spread</label>
                            <div class="range-row">
                                <span class="range-label">Min</span>
                                <input type="range" id="param-spread-min" min="0" max="1" value="0" step="0.01">
                                <span class="param-value" id="val-spread-min">0.00</span>
                            </div>
                            <div class="range-row">
                                <span class="range-label">Max</span>
                                <input type="range" id="param-spread-max" min="0" max="1" value="0" step="0.01">
                                <span class="param-value" id="val-spread-max">0.00</span>
                            </div>
                            <div class="gesture-indicator" data-param="spread"></div>
                        </div>
                        <div class="param-group range-group">
                            <label>Pan</label>
                            <div class="range-row">
                                <span class="range-label">Min</span>
                                <input type="range" id="param-pan-min" min="-1" max="1" value="0" step="0.01">
                                <span class="param-value" id="val-pan-min">0.00</span>
                            </div>
                            <div class="range-row">
                                <span class="range-label">Max</span>
                                <input type="range" id="param-pan-max" min="-1" max="1" value="0" step="0.01">
                                <span class="param-value" id="val-pan-max">0.00</span>
                            </div>
                            <div class="gesture-indicator" data-param="pan"></div>
                            <div class="random-range-bar" data-param="pan"></div>
                        </div>
                        <div class="param-group">
                            <label for="param-volume">Volume <span class="param-value" id="val-volume">0.70</span></label>
                            <input type="range" id="param-volume" min="0" max="1" value="0.7" step="0.01">
                        </div>
                        <div class="param-group envelope-row" id="envelope-row">
                            <label for="param-envelope">Envelope</label>
                            <div class="envelope-inline">
                                <select id="param-envelope">
                                    <option value="hann">Hann</option>
                                    <option value="tukey">Tukey</option>
                                    <option value="triangle">Triangle</option>
                                    <option value="gaussian">Gaussian</option>
                                    <option value="sigmoid">Sigmoid</option>
                                    <option value="blackman">Blackman</option>
                                    <option value="expodec">Expo Decay</option>
                                    <option value="rexpodec">Reverse Expo</option>
                                    <option value="custom" selected>Custom (ADSR)</option>
                                </select>
                                <canvas id="adsr-canvas"></canvas>
                            </div>
                        </div>
                    </div>
                </details>

                <details class="panel-section">
                    <summary>Gesture Mapping</summary>
                    <div class="section-content">
                        <div class="param-group gesture-map-group">
                            <label for="map-pressure">
                                Pressure
                                <span class="gesture-status" id="status-pressure">not detected</span>
                            </label>
                            <select id="map-pressure">
                                <option value="none" selected>None</option>
                                <option value="grainSize">Grain Size</option>
                                <option value="density">Density</option>
                                <option value="spread">Spread</option>
                                <option value="amplitude">Amplitude</option>
                                <option value="pitch">Pitch</option>
                            </select>
                            <div class="gesture-meter">
                                <div class="gesture-meter-fill" id="meter-pressure"></div>
                            </div>
                        </div>
                        <div class="param-group gesture-map-group">
                            <label for="map-contact-size">
                                Contact Size
                                <span class="gesture-status" id="status-contact-size">not detected</span>
                            </label>
                            <select id="map-contact-size">
                                <option value="none" selected>None</option>
                                <option value="grainSize">Grain Size</option>
                                <option value="density">Density</option>
                                <option value="spread">Spread</option>
                                <option value="amplitude">Amplitude</option>
                                <option value="pitch">Pitch</option>
                            </select>
                            <div class="gesture-meter">
                                <div class="gesture-meter-fill" id="meter-contact-size"></div>
                            </div>
                        </div>
                        <div class="param-group gesture-map-group">
                            <label for="map-velocity">
                                Velocity
                                <span class="gesture-status active" id="status-velocity">available</span>
                            </label>
                            <select id="map-velocity">
                                <option value="none" selected>None</option>
                                <option value="grainSize">Grain Size</option>
                                <option value="density">Density</option>
                                <option value="spread">Spread</option>
                                <option value="amplitude">Amplitude</option>
                                <option value="pitch">Pitch</option>
                            </select>
                            <div class="gesture-meter">
                                <div class="gesture-meter-fill" id="meter-velocity"></div>
                            </div>
                        </div>
                    </div>
                </details>
            </div>
        </main>
    </div>

    <script type="module" src="src/main.js"></script>
</body>
</html>
